{"version":3,"file":"osana.worker.js","mappings":"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","sources":["webpack://osana/./src/lib/util/worker.ts"],"sourcesContent":["var __awaiter = (this && this.__awaiter) || function (thisArg, _arguments, P, generator) {\n    function adopt(value) { return value instanceof P ? value : new P(function (resolve) { resolve(value); }); }\n    return new (P || (P = Promise))(function (resolve, reject) {\n        function fulfilled(value) { try { step(generator.next(value)); } catch (e) { reject(e); } }\n        function rejected(value) { try { step(generator[\"throw\"](value)); } catch (e) { reject(e); } }\n        function step(result) { result.done ? resolve(result.value) : adopt(result.value).then(fulfilled, rejected); }\n        step((generator = generator.apply(thisArg, _arguments || [])).next());\n    });\n};\nimportScripts(\"./osana.bundle.js\");\nimportScripts(\"./osana.config.js\");\nself.OsanaServiceWorker = class OsanaServiceWorker {\n    constructor() {\n        this.config = self.__osana$config;\n        this.bundle = self.__osana$bundle;\n        this.bareClient = new this.bundle.BareClient(this.config.bare);\n    }\n    fetch(event) {\n        return __awaiter(this, void 0, void 0, function* () {\n            const url = this.config.codec.decode(new URL(event.request.url).pathname.replace(this.config.prefix, \"\")) + new URL(event.request.url).search;\n            if (!/^https?:\\/\\//.test(url)) {\n                return fetch(event.request.url);\n            }\n            const requestURL = new URL(url);\n            const requestHeaders = this.bundle.rewrite.headers.request(Object.fromEntries(event.request.headers.entries()), requestURL);\n            if (this.config.blacklist && this.config.blacklist.some(regex => regex.test(requestURL.host))) {\n                return new BlackListedResponse();\n            }\n            const bareRequestData = {\n                method: event.request.method,\n                headers: requestHeaders\n            };\n            if (![\"GET\", \"HEAD\"].includes(event.request.method))\n                bareRequestData.body = yield event.request.blob();\n            const response = yield this.bareClient.fetch(requestURL, bareRequestData);\n            let responseStatus = response.rawResponse.status;\n            const responseHeaders = this.bundle.rewrite.headers.response(response.rawHeaders, requestURL);\n            let responseData = \"\";\n            if (/text\\/html/.test(responseHeaders[\"Content-Type\"])) {\n                responseData =\n                    `<head>` +\n                        `<script src=\"${this.config.files.bundle}\"></script>` +\n                        `<script src=\"${this.config.files.config}\"></script>` +\n                        `<script src=\"${this.config.files.client}\"></script>` +\n                        `<link rel=\"icon\" href=\"data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAAAXNSR0IArs4c6QAAAA1JREFUGFdjYGBkZAAAAAoAAx9k7/gAAAAASUVORK5CYIIA\">` +\n                        `<link rel=\"icon\" href=\"${requestURL.origin}/favicon.ico\">` +\n                        `${(responseStatus === 301 && responseHeaders[\"location\"]) ? `<meta http-equiv=\"refresh\" content=\"0; url=${this.bundle.rewrite.url(responseHeaders[\"location\"])}\">` : \"\"}` +\n                        `</head>`;\n                responseData += this.bundle.rewrite.html(yield response.text(), (requestURL.origin + requestURL.pathname));\n            }\n            else if (/text\\/css/.test(responseHeaders[\"Content-Type\"]) || event.request.destination === \"style\") {\n                responseData = this.bundle.rewrite.css(yield response.text(), (requestURL.origin + requestURL.pathname));\n            }\n            else if (/application\\/javascript/.test(responseHeaders[\"Content-Type\"]) || event.request.destination === \"script\") {\n                responseData = this.bundle.rewrite.js(yield response.text());\n            }\n            else {\n                responseData = yield response.arrayBuffer();\n            }\n            return new Response(responseData, {\n                status: response.rawResponse.status,\n                statusText: response.rawResponse.statusText,\n                headers: responseHeaders\n            });\n        });\n    }\n};\nclass BlackListedResponse extends Response {\n    constructor() {\n        super(\"Forbidden\", {\n            status: 403,\n            statusText: \"Forbidden\",\n            headers: {\n                \"Content-Type\": \"text/plain\"\n            }\n        });\n    }\n}\nexport {};\n"],"names":["importScripts","self","OsanaServiceWorker","constructor","this","config","__osana$config","bundle","__osana$bundle","bareClient","BareClient","bare","fetch","event","thisArg","_arguments","generator","url","codec","decode","URL","request","pathname","replace","prefix","search","test","requestURL","requestHeaders","rewrite","headers","Object","fromEntries","entries","blacklist","some","regex","host","BlackListedResponse","bareRequestData","method","includes","body","blob","response","responseStatus","rawResponse","status","responseHeaders","rawHeaders","responseData","files","client","origin","html","text","destination","css","js","arrayBuffer","Response","statusText","P","Promise","resolve","reject","fulfilled","value","step","next","e","rejected","result","done","then","apply","super"],"sourceRoot":""}